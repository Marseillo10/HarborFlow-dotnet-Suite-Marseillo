@using HarborFlowSuite.Core.DTOs
@using HarborFlowSuite.Shared.DTOs
@using HarborFlowSuite.Core.Models

<MudDrawer Open="@Open" OpenChanged="@OnDrawerOpenChanged" Anchor="Anchor.End" Elevation="1"
    Variant="@DrawerVariant.Temporary" Width="400px">
    <MudDrawerHeader Class="d-flex justify-space-between align-center">
        <MudText Typo="Typo.h6">Vessel Details</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="CloseDrawer" Color="Color.Inherit" />
    </MudDrawerHeader>
    <MudDrawerContainer>
        @if (Vessel != null)
        {
            <MudList T="string">
                <MudListItem Icon="@Icons.Material.Filled.DirectionsBoat">
                    <MudText Typo="Typo.subtitle2">Name</MudText>
                    <MudText Typo="Typo.body1">@Vessel.Name</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Numbers">
                    <MudText Typo="Typo.subtitle2">MMSI</MudText>
                    <div class="d-flex align-center">
                        <MudText Typo="Typo.body1" Class="mr-2">@Vessel.MMSI</MudText>
                        <MudTooltip Text="Copy MMSI">
                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                OnClick="@(() => CopyToClipboard(Vessel.MMSI, "MMSI"))" />
                        </MudTooltip>
                    </div>
                </MudListItem>
                @if (Metadata != null)
                {
                    <MudListItem Icon="@Icons.Material.Filled.Fingerprint">
                        <MudText Typo="Typo.subtitle2">IMO</MudText>
                        <div class="d-flex align-center">
                            <MudText Typo="Typo.body1" Class="mr-2">@(string.IsNullOrEmpty(Metadata.ImoNumber) ? "N/A" :
                        Metadata.ImoNumber)</MudText>
                                @if (!string.IsNullOrEmpty(Metadata.ImoNumber))
                            {
                                <MudTooltip Text="Copy IMO">
                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                        OnClick="@(() => CopyToClipboard(Metadata.ImoNumber, "IMO"))" />
                                </MudTooltip>
                            }
                        </div>
                    </MudListItem>
                }
                <MudListItem Icon="@Icons.Material.Filled.Category">
                    <MudText Typo="Typo.subtitle2">Type</MudText>
                    <MudText Typo="Typo.body1">@Vessel.Type</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Speed">
                    <MudText Typo="Typo.subtitle2">Speed</MudText>
                    <MudText Typo="Typo.body1">@Vessel.Speed knots</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Explore">
                    <MudText Typo="Typo.subtitle2">Heading</MudText>
                    <MudText Typo="Typo.body1">@Vessel.Heading Â°</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.LocationOn">
                    <MudText Typo="Typo.subtitle2">Coordinates</MudText>
                    <MudText Typo="Typo.body2">Lat: @Vessel.Latitude.ToString("F4")</MudText>
                    <MudText Typo="Typo.body2">Lng: @Vessel.Longitude.ToString("F4")</MudText>
                </MudListItem>
            </MudList>

            @if (Metadata != null)
            {
                <MudDivider />
                <MudText Typo="Typo.h6" Class="mt-4 ml-4">Metadata</MudText>
                <MudList T="string">
                    <MudListItem Icon="@Icons.Material.Filled.Flag">
                        <MudText Typo="Typo.subtitle2">Flag</MudText>
                        <MudText Typo="Typo.body1">@Metadata.Flag</MudText>
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Straighten">
                        <MudText Typo="Typo.subtitle2">Length</MudText>
                        <MudText Typo="Typo.body1">@Metadata.Length m</MudText>
                    </MudListItem>

                </MudList>
            }

            <div class="pa-4">
            @if (Guid.TryParse(Vessel.VesselId, out _))
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" FullWidth="true" Class="mb-2"
                        OnClick="CreateServiceRequest">Create Service Request</MudButton>
                }
                else
                {
                    <MudTooltip Text="Vessel not registered in system">
                        <MudButton Variant="Variant.Filled" Color="Color.Default" FullWidth="true" Class="mb-2" Disabled="true">
                            Create Service Request</MudButton>
                    </MudTooltip>
                }
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                    Href="@($"/vessel-details/{Vessel.MMSI}")">View Full Details</MudButton>
            </div>
        }
        else
        {
            <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
    </MudDrawerContainer>
</MudDrawer>

@code {
    [Parameter]
    public bool Open { get; set; }

    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }

    [Parameter]
    public VesselPositionDto Vessel { get; set; }

    [Parameter]
    public VesselMetadataDto Metadata { get; set; }

    public class VesselPositionDto
    {
        public string MMSI { get; set; }
        public string VesselId { get; set; }
        public string Name { get; set; }
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public double Heading { get; set; }
        public double Speed { get; set; }
        public string Type { get; set; }
    }

    private async Task CloseDrawer()
    {
        Open = false;
        await OpenChanged.InvokeAsync(false);
    }

    private async Task OnDrawerOpenChanged(bool isOpen)
    {
        Open = isOpen;
        await OpenChanged.InvokeAsync(isOpen);
    }

    [Inject] IDialogService DialogService { get; set; }
    [Inject] IJSRuntime JSRuntime { get; set; }
    [Inject] ISnackbar Snackbar { get; set; }

    private async Task CreateServiceRequest()
    {
        if (Guid.TryParse(Vessel.VesselId, out var vesselId))
        {
            var parameters = new DialogParameters { { "VesselId", vesselId } };
            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
            await DialogService.ShowAsync<HarborFlowSuite.Client.Shared.Dialogs.ServiceRequestDialog>("Add Service Request",
            parameters, options);
        }
    }

    private async Task CopyToClipboard(string text, string label)
    {
        if (!string.IsNullOrWhiteSpace(text))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Snackbar.Add($"{label} copied to clipboard", Severity.Success);
        }
    }
}
