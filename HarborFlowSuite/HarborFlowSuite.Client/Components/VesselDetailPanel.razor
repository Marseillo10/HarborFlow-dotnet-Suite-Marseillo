@using HarborFlowSuite.Core.DTOs
@using HarborFlowSuite.Shared.DTOs
@using HarborFlowSuite.Core.Models

<MudDrawer Open="@Open" OpenChanged="@OnDrawerOpenChanged" Anchor="Anchor.End" Elevation="1"
    Variant="@DrawerVariant.Temporary" Width="400px">
    <MudDrawerHeader Class="d-flex justify-space-between align-center">
        <MudText Typo="Typo.h6">Vessel Details</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="CloseDrawer" Color="Color.Inherit" />
    </MudDrawerHeader>
    <MudDrawerContainer>
        @if (Vessel != null)
        {
            <MudList T="string">
                <MudListItem Icon="@Icons.Material.Filled.DirectionsBoat">
                    <MudText Typo="Typo.subtitle2">Name</MudText>
                    <MudText Typo="Typo.body1">@Vessel.Name</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Numbers">
                    <MudText Typo="Typo.subtitle2">MMSI</MudText>
                    <div class="d-flex align-center">
                        <MudText Typo="Typo.body1" Class="mr-2">@Vessel.MMSI</MudText>
                        <MudTooltip Text="Copy MMSI">
                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                OnClick="@(() => CopyToClipboard(Vessel.MMSI, "MMSI"))" />
                        </MudTooltip>
                    </div>
                </MudListItem>
                @if (Metadata != null)
                {
                    <MudListItem Icon="@Icons.Material.Filled.Fingerprint">
                        <MudText Typo="Typo.subtitle2">IMO</MudText>
                        <div class="d-flex align-center">
                            <MudText Typo="Typo.body1" Class="mr-2">@(string.IsNullOrEmpty(Metadata.ImoNumber) ? "N/A" :
                        Metadata.ImoNumber)</MudText>
                                @if (!string.IsNullOrEmpty(Metadata.ImoNumber))
                            {
                                <MudTooltip Text="Copy IMO">
                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                        OnClick="@(() => CopyToClipboard(Metadata.ImoNumber, "IMO"))" />
                                </MudTooltip>
                            }
                        </div>
                    </MudListItem>
                }
                <MudListItem Icon="@Icons.Material.Filled.Category">
                    <MudText Typo="Typo.subtitle2">Type</MudText>
                    <MudText Typo="Typo.body1">@Vessel.Type</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Speed">
                    <MudText Typo="Typo.subtitle2">Speed</MudText>
                    <MudText Typo="Typo.body1">@Vessel.Speed knots</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Explore">
                    <MudText Typo="Typo.subtitle2">Heading</MudText>
                    <MudText Typo="Typo.body1">@Vessel.Heading Â°</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.LocationOn">
                    <MudText Typo="Typo.subtitle2">Coordinates</MudText>
                    <MudText Typo="Typo.body2">Lat: @Vessel.Latitude.ToString("F4")</MudText>
                    <MudText Typo="Typo.body2">Lng: @Vessel.Longitude.ToString("F4")</MudText>
                </MudListItem>
                @if (!string.IsNullOrEmpty(Vessel.NavigationalStatus))
                {
                    <MudListItem Icon="@GetStatusIcon(Vessel.NavigationalStatus)">
                        <div class="d-flex align-center">
                            <MudText Typo="Typo.subtitle2" Class="mr-2">Status</MudText>
                            <MudTooltip Text="@GetStatusDescription(Vessel.NavigationalStatus)">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Info" />
                            </MudTooltip>
                        </div>
                        <MudText Typo="Typo.body1">@Vessel.NavigationalStatus</MudText>
                    </MudListItem>
                }
                @if (!string.IsNullOrEmpty(Vessel.Destination))
                {
                    <MudListItem Icon="@Icons.Material.Filled.Place">
                        <MudText Typo="Typo.subtitle2">Destination</MudText>
                        <MudText Typo="Typo.body1">@Vessel.Destination</MudText>
                        @if (Vessel.Eta.HasValue)
                        {
                            <MudText Typo="Typo.caption">ETA: @Vessel.Eta.Value.ToString("g")</MudText>
                        }
                    </MudListItem>
                }
            </MudList>

            @if (Metadata != null)
            {
                <MudDivider />
                <MudText Typo="Typo.h6" Class="mt-4 ml-4">Metadata</MudText>
                <MudList T="string">
                    <MudListItem Icon="@Icons.Material.Filled.Flag">
                        <MudText Typo="Typo.subtitle2">Flag</MudText>
                        <MudText Typo="Typo.body1">@Metadata.Flag</MudText>
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Straighten">
                        <MudText Typo="Typo.subtitle2">Dimensions</MudText>
                        <MudText Typo="Typo.body1">L: @(Metadata.Length?.ToString("F1") ?? "N/A") m | W:
                            @(Metadata.Width?.ToString("F1") ?? "N/A") m</MudText>
                        @if (Metadata.Draught.HasValue)
                        {
                            <MudText Typo="Typo.body2">Draught: @Metadata.Draught.Value.ToString("F1") m</MudText>
                        }
                    </MudListItem>

                </MudList>
            }

            <div class="pa-4">
            @if (Guid.TryParse(Vessel.VesselId, out _))
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" FullWidth="true" Class="mb-2"
                        OnClick="CreateServiceRequest">Create Service Request</MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Class="mb-2"
                        OnClick="AddVessel">Add Vessel</MudButton>
                }
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                    Href="@($"/vessel-details/{Vessel.MMSI}")">View Full Details</MudButton>
            </div>
        }
        else
        {
            <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
    </MudDrawerContainer>
</MudDrawer>

@code {
    [Parameter]
    public bool Open { get; set; }

    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }

    [Parameter]
    public VesselPositionDto Vessel { get; set; }

    [Parameter]
    public VesselMetadataDto Metadata { get; set; }

    public class VesselPositionDto
    {
        public string MMSI { get; set; }
        public string VesselId { get; set; }
        public string Name { get; set; }
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public double Heading { get; set; }
        public double Speed { get; set; }
        public string Type { get; set; }
        public string NavigationalStatus { get; set; }
        public string Destination { get; set; }
        public DateTime? Eta { get; set; }
        public double? Length { get; set; }
        public double? Width { get; set; }
        public double? Draught { get; set; }
    }

    private async Task CloseDrawer()
    {
        Open = false;
        await OpenChanged.InvokeAsync(false);
    }

    private async Task OnDrawerOpenChanged(bool isOpen)
    {
        Open = isOpen;
        await OpenChanged.InvokeAsync(isOpen);
    }

    [Inject] IDialogService DialogService { get; set; }
    [Inject] IJSRuntime JSRuntime { get; set; }
    [Inject] ISnackbar Snackbar { get; set; }

    private async Task CreateServiceRequest()
    {
        if (Guid.TryParse(Vessel.VesselId, out var vesselId))
        {
            var parameters = new DialogParameters { { "VesselId", vesselId } };
            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
            await DialogService.ShowAsync<HarborFlowSuite.Client.Shared.Dialogs.ServiceRequestDialog>("Add Service Request",
            parameters, options);
        }
    }

    private async Task AddVessel()
    {
        var initialVessel = new Vessel
        {
            Name = Vessel.Name,
            MMSI = Vessel.MMSI,
            ImoNumber = Metadata?.ImoNumber ?? "",
            VesselType = Vessel.Type,
            Length = (decimal)(Metadata?.Length ?? 0),
            Width = (decimal)(Metadata?.Width ?? 0)
        };

        var parameters = new DialogParameters { { "InitialVessel", initialVessel } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<HarborFlowSuite.Client.Shared.Dialogs.VesselDialog>("Add Vessel", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Snackbar.Add("Vessel added successfully", Severity.Success);
            // Ideally, we should refresh the map or the panel to show the new state (e.g. "Create Service Request" enabled)
            // For now, we'll just close the drawer to force a refresh when re-opened or let the user re-click
            await CloseDrawer();
        }
    }

    private async Task CopyToClipboard(string text, string label)
    {
        if (!string.IsNullOrWhiteSpace(text))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Snackbar.Add($"{label} copied to clipboard", Severity.Success);
        }
    }
    private string GetStatusIcon(string status)
    {
        if (string.IsNullOrEmpty(status)) return Icons.Material.Filled.Navigation;
        
        if (status.Contains("sailing", StringComparison.OrdinalIgnoreCase)) return Icons.Material.Filled.Sailing;
        if (status.Contains("engine", StringComparison.OrdinalIgnoreCase)) return Icons.Material.Filled.Engineering;
        if (status.Contains("Moored", StringComparison.OrdinalIgnoreCase) || status.Contains("Anchor", StringComparison.OrdinalIgnoreCase)) return Icons.Material.Filled.Anchor;
        
        return Icons.Material.Filled.Navigation;
    }

    private string GetStatusDescription(string status)
    {
        if (string.IsNullOrEmpty(status)) return "Status unknown";

        if (status.Contains("using engine", StringComparison.OrdinalIgnoreCase)) return "Vessel is moving under engine power (Class A).";
        if (status.Contains("sailing", StringComparison.OrdinalIgnoreCase)) return "Vessel is moving under sail power.";
        if (status.Contains("Class B", StringComparison.OrdinalIgnoreCase)) return "Vessel is active (Class B transponder). Exact status not reported.";
        if (status.Contains("Moored", StringComparison.OrdinalIgnoreCase)) return "Vessel is secured to a dock or berth.";
        if (status.Contains("Anchor", StringComparison.OrdinalIgnoreCase)) return "Vessel is secured to the seabed.";
        if (status.Contains("Fishing", StringComparison.OrdinalIgnoreCase)) return "Vessel is actively engaged in fishing.";
        if (status.Contains("Command", StringComparison.OrdinalIgnoreCase)) return "Vessel is unable to maneuver as required.";

        return "Current navigational status reported by AIS.";
    }
}
