@using Microsoft.AspNetCore.Components.Web
@using HarborFlowSuite.Core.DTOs
@using HarborFlowSuite.Core.Models
@using HarborFlowSuite.Client.Services
@inject IJSRuntime JSRuntime
@inject IVesselPositionSignalRService VesselPositionSignalRService
@implements IAsyncDisposable

<div id="@MapElementId" style="width: 100%; height: 600px;"></div>


@code {
    [Parameter]
    public string MapElementId { get; set; } = "map";

    [Parameter]
    public EventCallback<int> OnTotalMapVesselCountChanged { get; set; }

    [Parameter]
    public EventCallback<List<VesselTypeSummaryDto>> OnVisibleVesselTypeSummaryChanged { get; set; }

    [Parameter]
    public IEnumerable<Port> Ports { get; set; }

    private DotNetObjectReference<VesselMap> _dotNetHelper;
    private IEnumerable<Port> _currentPorts;
    private bool _isMapInitialized;

    protected override async Task OnInitializedAsync()
    {
        _dotNetHelper = DotNetObjectReference.Create(this);
        VesselPositionSignalRService.OnPositionUpdateReceived += OnPositionUpdateReceived;
        await VesselPositionSignalRService.StartConnection();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine("VesselMap: OnAfterRenderAsync (firstRender). Initializing map...");
            await JSRuntime.InvokeVoidAsync("HarborFlowMap.initMap", MapElementId, _dotNetHelper);
            _isMapInitialized = true;
            Console.WriteLine("VesselMap: Map initialized.");
            
            if (_currentPorts != null && _currentPorts.Any())
            {
                Console.WriteLine($"VesselMap: Initial ports available ({_currentPorts.Count()}). Invoking addPortMarkers.");
                await JSRuntime.InvokeVoidAsync("HarborFlowMap.addPortMarkers", _currentPorts);
            }
            else
            {
                Console.WriteLine("VesselMap: No initial ports to add.");
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        Console.WriteLine($"VesselMap: OnParametersSetAsync called. Ports count: {(Ports != null ? Ports.Count() : 0)}");
        if (Ports != null && Ports.Any() && (Ports != _currentPorts))
        {
            _currentPorts = Ports;
            if (_isMapInitialized)
            {
                Console.WriteLine($"VesselMap: Map is initialized. Invoking addPortMarkers with {_currentPorts.Count()} ports.");
                await JSRuntime.InvokeVoidAsync("HarborFlowMap.addPortMarkers", _currentPorts);
            }
            else
            {
                Console.WriteLine("VesselMap: Map is NOT yet initialized. Skipping addPortMarkers.");
            }
        }
    }

    private void OnPositionUpdateReceived(string mmsi, double lat, double lng, double heading, double speed, string name, string vesselType, VesselMetadataDto metadata)
    {
        UpdateVesselMarker(mmsi, lat, lng, heading, speed, name, vesselType, metadata);
        StateHasChanged();
    }

    public async Task UpdateVesselMarker(string mmsi, double lat, double lng, double heading, double speed, string name, string vesselType, VesselMetadataDto metadata)
    {
        await JSRuntime.InvokeVoidAsync("HarborFlowMap.updateVesselMarker", mmsi, lat, lng, heading, speed, name, vesselType, metadata);
    }

    [JSInvokable]
    public async Task UpdateTotalMapVesselCount(int count)
    {
        await OnTotalMapVesselCountChanged.InvokeAsync(count);
    }

    [JSInvokable]
    public async Task UpdateVisibleVesselTypeSummary(List<VesselTypeSummaryDto> summary)
    {
        await OnVisibleVesselTypeSummaryChanged.InvokeAsync(summary);
    }



    public async ValueTask DisposeAsync()
    {
        if (_dotNetHelper != null)
        {
            _dotNetHelper.Dispose();
        }
        VesselPositionSignalRService.OnPositionUpdateReceived -= OnPositionUpdateReceived;
        await VesselPositionSignalRService.StopConnection();
    }
}