@page "/register"
@using System.Net.Http
@using System.Net.Http.Json
@using HarborFlowSuite.Core.DTOs
@inject HttpClient Http
@inject NavigationManager NavigationManager

<h3>Register</h3>

<div class="card">
    <div class="card-body">
        <EditForm Model="@_registerUserDto" OnValidSubmit="HandleRegistration">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="name">Name</label>
                <InputText id="name" class="form-control" @bind-Value="_registerUserDto.Name" />
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <InputText id="email" class="form-control" @bind-Value="_registerUserDto.Email" />
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-group">
                    <InputText id="password" type="@(_showPassword ? "text" : "password")" class="form-control" @bind-Value="_registerUserDto.Password" />
                    <div class="input-group-append">
                        <span class="input-group-text" @onclick="TogglePasswordVisibility" style="cursor: pointer; font-size: 1.2rem; color: #6c757d;" title="@(_showPassword ? "Hide password" : "Show password")">
                            <i class="fas @(_showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                        </span>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Register</button>
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger mt-3">@_errorMessage</div>
            }
        </EditForm>
    </div>
</div>

@code {
    private readonly RegisterUserDto _registerUserDto = new() { Name = "", Email = "", Password = "" };
    private string? _errorMessage;
    private bool _showPassword;

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
    }

    private async Task HandleRegistration()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/auth/register", _registerUserDto);
            if (response.IsSuccessStatusCode)
            {
                NavigationManager.NavigateTo("/login");
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();
                _errorMessage = error != null && error.ContainsKey("message") ? error["message"] : "An unknown error occurred.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }
}
