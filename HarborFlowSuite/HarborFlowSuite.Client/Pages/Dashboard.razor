
@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@using HarborFlowSuite.Core.Models
@using HarborFlowSuite.Core.DTOs
@using System.Net.Http
@using System.Net.Http.Json
@using HarborFlowSuite.Client.Components
@using HarborFlowSuite.Client.Services
@using Microsoft.AspNetCore.SignalR.Client
@inject IHttpClientFactory ClientFactory
@inject HubConnection HubConnection

@attribute [Authorize]

<PageTitle>Dashboard</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Dashboard Overview</h1>
    <button class="btn btn-primary">
        <i class="fas fa-plus me-2"></i> Quick Action
    </button>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-ship fa-2x text-primary me-3"></i>
                    <div>
                        <h5 class="card-title mb-0">Vessels</h5>
                        <p class="card-text text-muted">Total number of vessels:</p>
                    </div>
                </div>
                <h2 class="card-text"><strong><AnimatedCounter Value="@_vesselCount" /></strong></h2>
                <a href="/vessel-management" class="btn btn-outline-primary mt-3">Manage Vessels <i class="fas fa-arrow-right ms-2"></i></a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-clipboard-list fa-2x text-success me-3"></i>
                    <div>
                        <h5 class="card-title mb-0">Service Requests</h5>
                        <p class="card-text text-muted">Total pending requests:</p>
                    </div>
                </div>
                <h2 class="card-text"><strong>@_pendingServiceRequestCount</strong></h2>
                <a href="/service-request-management" class="btn btn-outline-success mt-3">Manage Requests <i class="fas fa-arrow-right ms-2"></i></a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-building fa-2x text-info me-3"></i>
                    <div>
                        <h5 class="card-title mb-0">Companies</h5>
                        <p class="card-text text-muted">Total registered companies:</p>
                    </div>
                </div>
                <h2 class="card-text"><strong>@_companyCount</strong></h2>
                <a href="/company-management" class="btn btn-outline-info mt-3">Manage Companies <i class="fas fa-arrow-right ms-2"></i></a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header">
                Service Request Status
            </div>
            <div class="card-body">
                @if (_serviceRequestStatusSummary != null)
                {
                    <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                        @foreach (var item in _serviceRequestStatusSummary)
                        {
                            <div class="bar" style="height: @(item.Count * 20)px; background-color: @GetStatusColor(item.Status);">
                                <span class="bar-label">@item.Status (@item.Count)</span>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p>Loading service request status...</p>
                }
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header">
                Vessel Count by Type
            </div>
            <div class="card-body">
                @if (_vesselTypeSummary != null)
                {
                    <VesselTypePolarAreaChart Data="@_vesselTypeSummary" />
                }
                else
                {
                    <p>Loading vessel type summary...</p>
                }
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                Interactive Map
            </div>
            <div class="card-body map-container" style="height: 600px;">
                <VesselMap @ref="vesselMap" OnTotalMapVesselCountChanged="OnVesselCountChanged" OnVisibleVesselTypeSummaryChanged="OnVesselTypeSummaryChanged" />
            </div>
        </div>
    </div>
</div>

@code {
    private int _vesselCount;
    private int _pendingServiceRequestCount;
    private int _companyCount;
    private List<ServiceRequestStatusSummaryDto> _serviceRequestStatusSummary;
    private List<VesselTypeSummaryDto> _vesselTypeSummary;
    private VesselMap? vesselMap;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine("Dashboard OnInitializedAsync started.");
            var client = ClientFactory.CreateClient("HarborFlowSuite.ServerAPI");

            Console.WriteLine("Fetching service request, and company data...");
            var serviceRequestTask = client.GetFromJsonAsync<ServiceRequest[]>("api/servicerequest");
            var companyTask = client.GetFromJsonAsync<Company[]>("api/company");

            Console.WriteLine("Fetching dashboard summary data...");
            var serviceRequestStatusTask = client.GetFromJsonAsync<List<ServiceRequestStatusSummaryDto>>("api/dashboard/servicerequeststatus");
            var vesselTypeTask = client.GetFromJsonAsync<List<VesselTypeSummaryDto>>("api/dashboard/vesseltypes");

            await Task.WhenAll(serviceRequestTask, companyTask, serviceRequestStatusTask, vesselTypeTask);
            Console.WriteLine("All data fetched.");

            _pendingServiceRequestCount = serviceRequestTask.Result?.Count(r => r.Status == ServiceRequestStatus.Pending) ?? 0;
            _companyCount = companyTask.Result?.Length ?? 0;
            _serviceRequestStatusSummary = serviceRequestStatusTask.Result;
            _vesselTypeSummary = vesselTypeTask.Result;

            Console.WriteLine("Dashboard data processed.");

            if (HubConnection.State == HubConnectionState.Disconnected)
            {
                await HubConnection.StartAsync();
            }

            HubConnection.On<string, double, double, double, double, string, string, VesselMetadataDto>("ReceiveVesselPositionUpdate",
                async (mmsi, lat, lng, heading, speed, name, vesselType, metadata) =>
                {
                    if (vesselMap != null)
                    {
                        await vesselMap.UpdateVesselMarker(mmsi, lat, lng, heading, speed, name, vesselType, metadata);
                        await InvokeAsync(StateHasChanged);
                    }
                });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in Dashboard OnInitializedAsync: {ex.Message}");
        }
        StateHasChanged();
    }

    private void OnVesselCountChanged(int count)
    {
        _vesselCount = count;
        InvokeAsync(StateHasChanged);
    }

    private void OnVesselTypeSummaryChanged(List<VesselTypeSummaryDto> summary)
    {
        _vesselTypeSummary = summary;
        StateHasChanged();
    }

    private string GetStatusColor(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "#ffc107",
            "approved" => "#28a745",
            "rejected" => "#dc3545",
            _ => "#6c757d",
        };
    }

    private string GetRandomColor()
    {
        var random = new Random();
        return String.Format("#{0:X6}", random.Next(0x1000000));
    }
}
<style>
    .chart-container {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        border-bottom: 1px solid #ccc;
        padding-bottom: 10px;
    }

    .bar {
        width: 50px;
        text-align: center;
        color: white;
        position: relative;
        transition: height 0.3s ease-in-out;
    }

    .bar-label {
        position: absolute;
        bottom: -25px;
        width: 100%;
        text-align: center;
        font-size: 12px;
        color: #333;
    }
</style>

