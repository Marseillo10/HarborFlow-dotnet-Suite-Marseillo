@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@using HarborFlowSuite.Core.Models
@using HarborFlowSuite.Core.DTOs
@using System.Net.Http
@using System.Net.Http.Json
@using HarborFlowSuite.Client.Components
@using HarborFlowSuite.Client.Services
@using HarborFlowSuite.Core.Services
@using Microsoft.AspNetCore.SignalR.Client
@inject IHttpClientFactory ClientFactory
@inject HubConnection HubConnection
@inject IJSRuntime JSRuntime
@inject HarborFlowSuite.Core.Services.IPortService PortService
@inject ILogger<Dashboard> Logger
@attribute [Authorize]

<PageTitle>Dashboard</PageTitle>

<MudContainer MaxWidth="@(_isMapFullScreen ? MaxWidth.False : MaxWidth.Large)"
    Class="@(_isMapFullScreen ? "pa-0 ma-0" : "")"
    Style="@(_isMapFullScreen ? "height: calc(100vh - var(--mud-appbar-height)); overflow: hidden;" : "")">
    @if (!_isMapFullScreen)
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <MudText Typo="Typo.h4">Dashboard Overview</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">Quick Action
            </MudButton>
        </div>
    }

    <MudGrid Class="animate-fade-in-up" Spacing="@(_isMapFullScreen ? 0 : 4)"
        Style="@(_isMapFullScreen ? "height: 100%;" : "")">
        <!-- Summary Cards Row -->
        @if (!_isMapFullScreen)
        {
            <MudItem xs="12" md="4">
                <MudGrid Spacing="4">
                    <MudItem xs="12">
                        <MudCard Elevation="4" Class="glass-card rounded-xl pa-4" Style="height: 350px;">
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center">
                                    <div>
                                        <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Total Vessels
                                        </MudText>
                                        <MudText Typo="Typo.h3" Class="font-weight-bold text-primary">
                                            <AnimatedCounter Value="@_vesselCount" />
                                        </MudText>
                                    </div>
                                    <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large"
                                        Class="rounded-lg shadow-lg">
                                        <MudIcon Icon="@Icons.Material.Filled.DirectionsBoat" Size="Size.Medium" />
                                    </MudAvatar>
                                </div>
                                <MudText Typo="Typo.caption" Class="mt-2 d-block text-success font-weight-bold">
                                    <MudIcon Icon="@Icons.Material.Filled.ArrowUpward" Size="Size.Small" Class="mr-1" />
                                    Active in port
                                </MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary"
                                    EndIcon="@Icons.Material.Filled.ArrowForward" Href="/vessel-management" FullWidth="true"
                                    Class="hover-underline">View
                                    Details</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12">
                        <MudCard Elevation="4" Class="glass-card rounded-xl" Style="height: 350px;">
                            <MudCardContent Class="d-flex flex-column relative h-100">
                                <div class="d-flex justify-space-between align-center w-100 z-10">
                                    <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Vessel Types</MudText>
                                    <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large"
                                        Class="rounded-lg shadow-lg">
                                        <MudIcon Icon="@Icons.Material.Filled.DirectionsBoat" Size="Size.Medium" />
                                    </MudAvatar>
                                </div>
                                @if (_vesselTypeSummary != null)
                                {
                                    <div class="relative d-flex align-center justify-center flex-grow-1"
                                        style="width: 100%; min-height: 0;">
                                        <MudChart ChartType="ChartType.Donut" InputData="@_vesselTypeData"
                                            InputLabels="@_vesselTypeLabels" Width="100%" Height="200px"
                                            ChartOptions="@_vesselChartOptions" LegendPosition="Position.Bottom" />
                                        <div class="absolute-center text-center pointer-events-none">
                                            <MudText Typo="Typo.h4" Class="font-weight-bold">@_vesselTypeData.Sum()</MudText>
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Vessels</MudText>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex justify-center align-center flex-grow-1">
                                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                                    </div>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudItem>
        }

        <MudItem xs="12" md="@(_isMapFullScreen ? 12 : 8)"
            Style="@(_isMapFullScreen ? "height: 100%; padding: 0;" : "")">
            <MudCard Elevation="@(_isMapFullScreen ? 0 : 4)"
                Class="@(_isMapFullScreen ? "rounded-0 h-100" : "glass-card rounded-xl overflow-hidden h-100")">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Class="font-weight-bold">Live Port Operations</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">Real-time vessel tracking</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <LayerSwitcher Layers="_mapLayers" SelectedLayer="_selectedLayer"
                            OnLayerSelected="OnLayerSelected" />
                        <MudTooltip Text="@(_isMapFullScreen ? "Exit Full Screen" : "Full Screen")">
                            <MudIconButton
                                Icon="@(_isMapFullScreen ? Icons.Material.Filled.FullscreenExit : Icons.Material.Filled.Fullscreen)"
                                OnClick="ToggleMapFullScreen" Color="Color.Default" />
                        </MudTooltip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="pa-0" Style="@(_isMapFullScreen ? "height: calc(100% - 64px);" : "")">
                    <div class="map-container" style="@(_isMapFullScreen ? "height: 100%;" : "height: 650px;")">
                        <VesselMap @ref="vesselMap" OnTotalMapVesselCountChanged="OnVesselCountChanged"
                            OnVisibleVesselTypeSummaryChanged="OnVesselTypeSummaryChanged" Ports="@_ports"
                            OnVesselClick="OnVesselSelected" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Main Content Row -->
        <!-- Left Column: Charts (Smaller) -->
        @if (!_isMapFullScreen)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="4" Class="glass-card rounded-xl" Style="height: 350px;">
                    <MudCardContent Class="d-flex flex-column h-100">
                        <div class="d-flex justify-space-between align-center w-100 mb-2">
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Service Request Analytics
                            </MudText>
                            <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large"
                                Class="rounded-lg shadow-lg">
                                <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Medium" />
                            </MudAvatar>
                        </div>
                        @if (_serviceRequestStatusSummary != null)
                        {
                            <div class="d-flex align-center justify-center flex-grow-1" style="min-height: 0;">
                                <MudChart ChartType="ChartType.Bar" ChartSeries="@_serviceRequestSeries"
                                    XAxisLabels="@_serviceRequestLabels" Width="100%" Height="200px"></MudChart>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex justify-center align-center flex-grow-1">
                                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Right Column: Map (Larger) -->
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="4" Class="glass-card rounded-xl pa-4" Style="height: 350px;">
                    <MudCardContent>
                        <div class="d-flex justify-space-between align-center">
                            <div>
                                <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Pending Requests</MudText>
                                <MudText Typo="Typo.h3" Class="font-weight-bold text-warning">@_pendingServiceRequestCount
                                </MudText>
                            </div>
                            <MudAvatar Color="Color.Warning" Variant="Variant.Filled" Size="Size.Large"
                                Class="rounded-lg shadow-lg">
                                <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Medium" />
                            </MudAvatar>
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-2 d-block mud-text-secondary">
                            Requires attention
                        </MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Warning"
                            EndIcon="@Icons.Material.Filled.ArrowForward" Href="/service-request-management"
                            FullWidth="true" Class="hover-underline">Manage Requests</MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="4" Class="glass-card rounded-xl pa-4" Style="height: 350px;">
                    <MudCardContent>
                        <div class="d-flex justify-space-between align-center">
                            <div>
                                <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Registered Companies
                                </MudText>
                                <MudText Typo="Typo.h3" Class="font-weight-bold text-info">@_companyCount</MudText>
                            </div>
                            <MudAvatar Color="Color.Info" Variant="Variant.Filled" Size="Size.Large"
                                Class="rounded-lg shadow-lg">
                                <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Medium" />
                            </MudAvatar>
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-2 d-block mud-text-secondary">
                            Partner ecosystem
                        </MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Info" EndIcon="@Icons.Material.Filled.ArrowForward"
                            Href="/company-management" FullWidth="true" Class="hover-underline">Directory</MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    <VesselDetailPanel @bind-Open="_isDetailPanelOpen" Vessel="_selectedVessel" Metadata="_selectedMetadata" />
</MudContainer>

@code {
    private int _vesselCount;
    private int _pendingServiceRequestCount;
    private int _companyCount;
    private List<ServiceRequestStatusSummaryDto> _serviceRequestStatusSummary;
    private List<VesselTypeSummaryDto> _vesselTypeSummary;
    private VesselMap? vesselMap;
    private string _selectedLayer = "openstreetmap";
    private Dictionary<string, LayerSwitcher.LayerInfo> _mapLayers;
    private IEnumerable<Port> _ports;

    private bool _isDetailPanelOpen;
    private VesselDetailPanel.VesselPositionDto _selectedVessel;
    private VesselMetadataDto _selectedMetadata;
    private Dictionary<string, (VesselDetailPanel.VesselPositionDto Info, VesselMetadataDto Metadata)> _vesselCache = new();

    // Chart Data
    private List<ChartSeries> _serviceRequestSeries = new();
    private string[] _serviceRequestLabels = { };
    private double[] _vesselTypeData = { };
    private string[] _vesselTypeLabels = { };
    private ChartOptions _vesselChartOptions = new ChartOptions
        {
            ChartPalette = new[] { "#3B82F6", "#10B981", "#F59E0B", "#EF4444", "#8B5CF6", "#EC4899", "#6366F1", "#14B8A6",
"#F97316", "#84CC16" },
            LineStrokeWidth = 5
        };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _mapLayers = new Dictionary<string, LayerSwitcher.LayerInfo>
{
{ "openstreetmap", new LayerSwitcher.LayerInfo { Name = "OpenStreetMap", Thumbnail =
"/images/map_thumbnails/openstreetmap.png" } },
{ "nasa_gibs", new LayerSwitcher.LayerInfo { Name = "NASA GIBS", Thumbnail = "/images/map_thumbnails/nasa_gibs.png" } },
{ "esri_worldimagery", new LayerSwitcher.LayerInfo { Name = "Esri World Imagery", Thumbnail =
"/images/map_thumbnails/esri_worldimagery.png" } }
};

            Logger.LogInformation("Dashboard OnInitializedAsync started.");
            var client = ClientFactory.CreateClient("HarborFlowSuite.ServerAPI");

            var portsTask = PortService.GetPortsAsync(null);

            Logger.LogInformation("Fetching service request, and company data...");
            var serviceRequestTask = client.GetFromJsonAsync<ServiceRequest[]>("api/servicerequest");
            var companyTask = client.GetFromJsonAsync<Company[]>("api/company");

            Logger.LogInformation("Fetching dashboard summary data...");
            var serviceRequestStatusTask =
            client.GetFromJsonAsync<List<ServiceRequestStatusSummaryDto>>("api/dashboard/servicerequeststatus");
            var vesselTypeTask = client.GetFromJsonAsync<List<VesselTypeSummaryDto>>("api/dashboard/vesseltypes");

            await Task.WhenAll(serviceRequestTask, companyTask, serviceRequestStatusTask, vesselTypeTask, portsTask);
            Logger.LogInformation("All data fetched.");

            _ports = portsTask.Result;
            Logger.LogInformation($"Dashboard: Fetched {_ports?.Count() ?? 0} ports.");
            _pendingServiceRequestCount = serviceRequestTask.Result?.Count(r => r.Status == ServiceRequestStatus.Pending) ?? 0;
            _companyCount = companyTask.Result?.Length ?? 0;
            _serviceRequestStatusSummary = serviceRequestStatusTask.Result;
            _vesselTypeSummary = vesselTypeTask.Result;

            // Prepare Chart Data
            if (_serviceRequestStatusSummary != null)
            {
                _serviceRequestLabels = _serviceRequestStatusSummary.Select(x => x.Status).ToArray();
                _serviceRequestSeries = new List<ChartSeries>
{
new ChartSeries { Name = "Requests", Data = _serviceRequestStatusSummary.Select(x => (double)x.Count).ToArray() }
};
            }

            if (_vesselTypeSummary != null)
            {
                _vesselTypeLabels = _vesselTypeSummary.Select(x => x.VesselType).ToArray();
                _vesselTypeData = _vesselTypeSummary.Select(x => (double)x.Count).ToArray();
            }

            Logger.LogInformation("Dashboard data processed.");

            if (HubConnection.State == HubConnectionState.Disconnected)
            {
                try
                {
                    await HubConnection.StartAsync();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error starting SignalR connection: {ex.Message}");
                }
            }

            HubConnection.On<string, double, double, double, double, string, string,
            VesselMetadataDto>("ReceiveVesselPositionUpdate",
            async (mmsi, lat, lng, heading, speed, name, vesselType, metadata) =>
            {
                var vesselInfo = new VesselDetailPanel.VesselPositionDto
                    {
                        MMSI = mmsi,
                        Name = name,
                        Latitude = lat,
                        Longitude = lng,
                        Heading = heading,
                        Speed = speed,
                        Type = vesselType
                    };
                _vesselCache[mmsi] = (vesselInfo, metadata);

                if (vesselMap != null)
                {
                    await vesselMap.UpdateVesselMarker(mmsi, lat, lng, heading, speed, name, vesselType, metadata);
                    await InvokeAsync(StateHasChanged);
                }
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in Dashboard OnInitializedAsync: {Message}", ex.Message);
        }
        StateHasChanged();
    }

    private void OnVesselSelected(string mmsi)
    {
        if (_vesselCache.TryGetValue(mmsi, out var data))
        {
            _selectedVessel = data.Info;
            _selectedMetadata = data.Metadata;
            _isDetailPanelOpen = true;
            StateHasChanged();
        }
    }

    private void OnVesselCountChanged(int count)
    {
        _vesselCount = count;
        InvokeAsync(StateHasChanged);
    }

    private void OnVesselTypeSummaryChanged(List<VesselTypeSummaryDto> summary)
    {
        _vesselTypeSummary = summary;
        // Update chart data dynamically if needed
        if (_vesselTypeSummary != null)
        {
            _vesselTypeLabels = _vesselTypeSummary.Select(x => x.VesselType).ToArray();
            _vesselTypeData = _vesselTypeSummary.Select(x => (double)x.Count).ToArray();
        }
        StateHasChanged();
    }

    private async Task OnLayerSelected(string layerKey)
    {
        _selectedLayer = layerKey;
        await JSRuntime.InvokeVoidAsync("HarborFlowMap.switchLayer", layerKey);
    }

    private bool _isMapFullScreen = false;

    private void ToggleMapFullScreen()
    {
        _isMapFullScreen = !_isMapFullScreen;
    }
}

<style>
    .glass-card {
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Dark Mode Styles */
    ::deep .theme-dark .glass-card,
    .theme-dark .glass-card {
        background: rgba(30, 41, 59, 0.7) !important;
        /* Slate 800 with opacity */
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    ::deep .theme-dark .glass-card:hover,
    .theme-dark .glass-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        border-color: rgba(59, 130, 246, 0.4);
        /* Primary color border on hover */
        background: rgba(30, 41, 59, 0.85) !important;
    }

    /* Light Mode Styles */
    ::deep .theme-light .glass-card,
    .theme-light .glass-card {
        background: rgba(255, 255, 255, 0.7) !important;
        /* White with opacity */
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    ::deep .theme-light .glass-card:hover,
    .theme-light .glass-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.05);
        border-color: rgba(59, 130, 246, 0.5);
        /* Primary color border on hover */
        background: rgba(255, 255, 255, 0.9) !important;
    }

    .shadow-lg {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .hover-underline:hover {
        text-decoration: underline;
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        opacity: 0;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .relative {
        position: relative;
    }

    .absolute-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 0;
    }

    .pointer-events-none {
        pointer-events: none;
    }
</style>
