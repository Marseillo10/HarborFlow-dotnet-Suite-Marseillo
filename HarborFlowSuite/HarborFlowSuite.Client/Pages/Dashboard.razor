@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@using HarborFlowSuite.Core.Models
@using HarborFlowSuite.Shared.DTOs
@using HarborFlowSuite.Core.DTOs
@using System.Net.Http
@using System.Net.Http.Json
@using HarborFlowSuite.Client.Components
@using HarborFlowSuite.Client.Services
@using HarborFlowSuite.Core.Services
@using Microsoft.AspNetCore.SignalR.Client
@inject IHttpClientFactory ClientFactory
@inject HubConnection HubConnection
@inject IServiceRequestSignalRService ServiceRequestSignalRService
@inject IVesselPositionSignalRService VesselPositionSignalRService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@inject HarborFlowSuite.Client.Services.PortService PortService
@inject ILogger<Dashboard> Logger
@attribute [Authorize]

<PageTitle>Dashboard</PageTitle>

<MudContainer MaxWidth="@(_isMapFullScreen ? MaxWidth.False : MaxWidth.Large)"
    Class="@(_isMapFullScreen ? "pa-0 ma-0" : "")"
    Style="@(_isMapFullScreen ? "height: calc(100vh - var(--mud-appbar-height)); overflow: hidden;" : "")">
    @if (!_isMapFullScreen)
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <MudText Typo="Typo.h4">Dashboard Overview</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">Quick Action
            </MudButton>
        </div>
    }

    <MudGrid Class="animate-fade-in-up" Spacing="@(_isMapFullScreen ? 0 : 4)"
        Style="@(_isMapFullScreen ? "height: 100%;" : "")">
        <!-- Summary Cards Row -->
        @if (!_isMapFullScreen)
        {
            <!-- Left Column: Unified Sidebar -->
            <MudItem xs="12" md="4">
                <MudCard Elevation="4" Class="glass-card rounded-xl h-100">
                    <MudCardContent Class="d-flex flex-column h-100">
                        <!-- Total Vessels Section -->
                        <div class="d-flex justify-space-between align-center">
                            <div>
                                <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Total Vessels</MudText>
                                <MudText Typo="Typo.h3" Class="font-weight-bold text-primary">
                                    <AnimatedCounter Value="@_vesselCount" />
                                </MudText>
                            </div>
                            <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large"
                                Class="rounded-lg shadow-lg">
                                <MudIcon Icon="@Icons.Material.Filled.DirectionsBoat" Size="Size.Medium" />
                            </MudAvatar>
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-2 d-block text-success font-weight-bold">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowUpward" Size="Size.Small" Class="mr-1" />
                            Active in port
                        </MudText>
                        
                        <div class="mt-4 mb-4">
                            <MudButton Variant="Variant.Text" Color="Color.Primary"
                                EndIcon="@Icons.Material.Filled.ArrowForward" Href="/vessel-management" FullWidth="true"
                                Class="hover-underline">View Details</MudButton>
                        </div>

                        <MudDivider Class="my-2" />

                        <!-- Vessel Types Section -->
                        <div class="d-flex justify-space-between align-center w-100 z-10 mt-4">
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Vessel Types</MudText>
                            <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large"
                                Class="rounded-lg shadow-lg">
                                <MudIcon Icon="@Icons.Material.Filled.PieChart" Size="Size.Medium" />
                            </MudAvatar>
                        </div>
                        @if (_vesselTypeSummary != null)
                        {
                            <div class="relative d-flex align-center justify-center flex-grow-1"
                                style="width: 100%; min-height: 200px;">
                                <MudChart ChartType="ChartType.Donut" InputData="@_vesselTypeData"
                                    InputLabels="@_vesselTypeLabels" Width="100%" Height="200px"
                                    ChartOptions="@_vesselChartOptions" LegendPosition="Position.Bottom" />
                                <div class="absolute-center text-center pointer-events-none" style="top: 42%;">
                                    <MudText Typo="Typo.h4" Class="font-weight-bold">@_vesselTypeData.Sum()</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Vessels</MudText>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex justify-center align-center flex-grow-1" style="min-height: 200px;">
                                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                            </div>
                        }

                        <MudDivider Class="my-4" />

                        <!-- Service Request Analytics Section -->
                        <div class="d-flex justify-space-between align-center w-100 z-10">
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Service Request Analytics</MudText>
                            <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large"
                                Class="rounded-lg shadow-lg">
                                <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Medium" />
                            </MudAvatar>
                        </div>
                        @if (_serviceRequestStatusSummary != null)
                        {
                            <div class="relative d-flex align-center justify-center flex-grow-1"
                                style="width: 100%; min-height: 200px;">
                                <MudChart ChartType="ChartType.Donut" InputData="@_serviceRequestData"
                                    InputLabels="@_serviceRequestLabels" Width="100%" Height="200px"
                                    LegendPosition="Position.Right" ChartOptions="@_serviceRequestChartOptions" />
                                <div class="absolute-center text-center pointer-events-none" style="left: 38%;">
                                    <MudText Typo="Typo.h4" Class="font-weight-bold">@_serviceRequestData.Sum()</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Requests</MudText>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex justify-center align-center flex-grow-1" style="min-height: 200px;">
                                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                            </div>
                        }
                        <div class="mt-auto">
                             <MudButton Variant="Variant.Text" Color="Color.Primary"
                                EndIcon="@Icons.Material.Filled.ArrowForward" Href="/service-request-management" FullWidth="true"
                                Class="hover-underline">View Details</MudButton>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Right Column: Map and Stats -->
            <MudItem xs="12" md="8">
                <MudGrid Spacing="4">
                    <!-- Map Section -->
                    <MudItem xs="12">
                         <MudCard Elevation="4" Class="glass-card rounded-xl" Style="height: 716px;">
                            <MudCardHeader Class="pa-4" Style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h5" Class="font-weight-bold text-white">Live Port Operation</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Real-time vessel tracking</MudText>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MapSearchInput IsFloating="false" 
                                        OnSearch="@(async (s) => await vesselMap.FilterVessels(s))" 
                                        Suggestions="@(vesselMap?.SearchSuggestions ?? new HashSet<string>())" />
                                </CardHeaderActions>
                            </MudCardHeader>
                            <MudCardContent Class="pa-0 relative" Style="height: calc(100% - 80px);">
                                <VesselMap @ref="vesselMap" 
                                    Ports="@_ports" 
                                    OnVesselClick="OnVesselSelected"
                                    OnPortClicked="OnPortCitySelected"
                                    OnTotalMapVesselCountChanged="OnVesselCountChanged"
                                    OnVisibleVesselTypeSummaryChanged="OnVesselTypeSummaryChanged" />
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <!-- Merged Stats Section -->
                    <MudItem xs="12">
                        <MudCard Elevation="4" Class="glass-card rounded-xl" Style="height: 350px;">
                            <MudCardContent Class="d-flex flex-row h-100 pa-6">
                                <!-- Pending Requests Section -->
                                <div class="d-flex flex-column justify-space-between flex-grow-1">
                                    <div class="d-flex justify-space-between align-center">
                                        <div>
                                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Pending Requests</MudText>
                                            <MudText Typo="Typo.h3" Class="font-weight-bold text-warning">@_pendingServiceRequestCount</MudText>
                                        </div>
                                        <MudAvatar Color="Color.Warning" Variant="Variant.Filled" Size="Size.Large"
                                            Class="rounded-lg shadow-lg">
                                            <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Medium" />
                                        </MudAvatar>
                                    </div>
                                    <div>
                                        <MudText Typo="Typo.caption" Class="d-block mud-text-secondary mb-2">Requires attention</MudText>
                                        <MudButton Variant="Variant.Text" Color="Color.Warning"
                                            EndIcon="@Icons.Material.Filled.ArrowForward" Href="/service-request-management"
                                            FullWidth="true" Class="hover-underline justify-start px-0">Manage Requests</MudButton>
                                    </div>
                                </div>

                                <MudDivider Vertical="true" FlexItem="true" Class="mx-6" />

                                <!-- Registered Companies Section -->
                                <div class="d-flex flex-column justify-space-between flex-grow-1">
                                    <div class="d-flex justify-space-between align-center">
                                        <div>
                                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">Registered Companies</MudText>
                                            <MudText Typo="Typo.h3" Class="font-weight-bold text-info">@_companyCount</MudText>
                                        </div>
                                        <MudAvatar Color="Color.Info" Variant="Variant.Filled" Size="Size.Large"
                                            Class="rounded-lg shadow-lg">
                                            <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Medium" />
                                        </MudAvatar>
                                    </div>
                                    <div>
                                        <MudText Typo="Typo.caption" Class="d-block mud-text-secondary mb-2">Partner ecosystem</MudText>
                                        <MudButton Variant="Variant.Text" Color="Color.Info" EndIcon="@Icons.Material.Filled.ArrowForward"
                                            Href="/company-management" FullWidth="true" Class="hover-underline justify-start px-0">Directory</MudButton>
                                    </div>
                                </div>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudItem>
        }
        else 
        {
             <!-- Fullscreen Map Mode -->
             <MudItem xs="12" Class="h-100">
                <MudCard Elevation="4" Class="glass-card rounded-xl h-100">
                            <MudCardHeader Class="pa-4" Style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h5" Class="font-weight-bold text-white">Live Port Operation</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Real-time vessel tracking</MudText>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MapSearchInput IsFloating="false" 
                                        OnSearch="@(async (s) => await vesselMap.FilterVessels(s))" 
                                        Suggestions="@(vesselMap?.SearchSuggestions ?? new HashSet<string>())" />
                                </CardHeaderActions>
                            </MudCardHeader>
                    <MudCardContent Class="pa-0 relative" Style="height: calc(100% - 80px);">
                        <VesselMap @ref="vesselMap" 
                            Ports="@_ports" 
                            OnVesselClick="OnVesselSelected"
                            OnPortClicked="OnPortCitySelected"
                            OnTotalMapVesselCountChanged="OnVesselCountChanged"
                            OnVisibleVesselTypeSummaryChanged="OnVesselTypeSummaryChanged" />
                    </MudCardContent>
                </MudCard>
             </MudItem>
        }
    </MudGrid>

    <VesselDetailPanel @bind-Open="_isDetailPanelOpen" Vessel="_selectedVessel" Metadata="_selectedMetadata" />
    
    <PortDetailPanel @bind-Open="_isPortDetailPanelOpen" Port="_selectedPort" VesselCount="_selectedPortCongestion" />
</MudContainer>

@code {
    private int _vesselCount;
    private int _pendingServiceRequestCount;
    private int _companyCount;
    private List<ServiceRequestStatusSummaryDto> _serviceRequestStatusSummary;
    private List<VesselTypeSummaryDto> _vesselTypeSummary;
    private VesselMap? vesselMap;
    private string _selectedLayer = "openstreetmap";
    private Dictionary<string, LayerSwitcher.LayerInfo> _mapLayers;
    private IEnumerable<Port> _ports;

    private bool _isDetailPanelOpen;
    private VesselDetailPanel.VesselPositionDto _selectedVessel;
    private VesselMetadataDto _selectedMetadata;
    private Dictionary<string, (VesselDetailPanel.VesselPositionDto Info, VesselMetadataDto Metadata)> _vesselCache = new();

    // Chart Data
    private double[] _serviceRequestData = { };
    private string[] _serviceRequestLabels = { };
    private double[] _vesselTypeData = { };
    private string[] _vesselTypeLabels = { };
    private ChartOptions _vesselChartOptions = new ChartOptions
        {
            ChartPalette = new[] { "#3B82F6", "#10B981", "#F59E0B", "#EF4444", "#8B5CF6", "#EC4899", "#6366F1", "#14B8A6",
"#F97316", "#84CC16" },
            LineStrokeWidth = 5
        };

    private ChartOptions _serviceRequestChartOptions = new ChartOptions
    {
        // Pending (Warning/Orange), Approved (Success/Green), Rejected (Error/Red), InProgress (Info/Blue), Completed (Tertiary/Purple), Cancelled (Dark/Dark Grey)
        ChartPalette = new[] { "#FF9800", "#00C853", "#F44336", "#2196F3", "#594AE2", "#545454" },
        LineStrokeWidth = 5
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _mapLayers = new Dictionary<string, LayerSwitcher.LayerInfo>
{
{ "openstreetmap", new LayerSwitcher.LayerInfo { Name = "OpenStreetMap", Thumbnail =
"/images/map_thumbnails/openstreetmap.png" } },
{ "nasa_gibs", new LayerSwitcher.LayerInfo { Name = "NASA GIBS", Thumbnail = "/images/map_thumbnails/nasa_gibs.png" } },
{ "esri_worldimagery", new LayerSwitcher.LayerInfo { Name = "Esri World Imagery", Thumbnail =
"/images/map_thumbnails/esri_worldimagery.png" } }
};

            Logger.LogInformation("Dashboard OnInitializedAsync started.");
            var client = ClientFactory.CreateClient("HarborFlowSuite.ServerAPI");

            var portsTask = PortService.GetPortsAsync(null);

            Logger.LogInformation("Fetching service request, and company data...");
            var serviceRequestTask = client.GetFromJsonAsync<ServiceRequest[]>("api/servicerequest");
            var companyTask = client.GetFromJsonAsync<Company[]>("api/company");

            Logger.LogInformation("Fetching dashboard summary data...");
            var serviceRequestStatusTask =
            client.GetFromJsonAsync<List<ServiceRequestStatusSummaryDto>>("api/dashboard/servicerequeststatus");
            var vesselTypeTask = client.GetFromJsonAsync<List<VesselTypeSummaryDto>>("api/dashboard/vesseltypes");

            await Task.WhenAll(serviceRequestTask, companyTask, serviceRequestStatusTask, vesselTypeTask, portsTask);
            Logger.LogInformation("All data fetched.");

            _ports = portsTask.Result;
            Logger.LogInformation($"Dashboard: Fetched {_ports?.Count() ?? 0} ports.");
            _pendingServiceRequestCount = serviceRequestTask.Result?.Count(r => r.Status == ServiceRequestStatus.Pending) ?? 0;
            _companyCount = companyTask.Result?.Length ?? 0;
            _serviceRequestStatusSummary = serviceRequestStatusTask.Result;
            _vesselTypeSummary = vesselTypeTask.Result;

            // Prepare Chart Data
            if (_serviceRequestStatusSummary != null)
            {
                // Sort to match the palette: Pending, Approved, Rejected, InProgress, Completed, Cancelled
                var sortedSummary = _serviceRequestStatusSummary.OrderBy(x =>
                {
                    return x.Status switch
                    {
                        "Pending" => 0,
                        "Approved" => 1,
                        "Rejected" => 2,
                        "InProgress" => 3,
                        "Completed" => 4,
                        "Cancelled" => 5,
                        _ => 6
                    };
                }).ToList();

                _serviceRequestLabels = sortedSummary.Select(x => x.Status).ToArray();
                _serviceRequestData = sortedSummary.Select(x => (double)x.Count).ToArray();
            }

            if (_vesselTypeSummary != null)
            {
                _vesselTypeLabels = _vesselTypeSummary.Select(x => x.VesselType).ToArray();
                _vesselTypeData = _vesselTypeSummary.Select(x => (double)x.Count).ToArray();
            }

            Logger.LogInformation("Dashboard data processed.");

            // Initialize vessel cache from service state
            foreach (var kvp in VesselPositionSignalRService.Vessels)
            {
                var update = kvp.Value.Position;
                if (update != null)
                {
                    var vesselInfo = new VesselDetailPanel.VesselPositionDto
                    {
                        MMSI = update.MMSI,
                        VesselId = update.VesselId?.ToString() ?? update.MMSI,
                        Name = update.Name,
                        Latitude = update.Latitude,
                        Longitude = update.Longitude,
                        Heading = update.Heading,
                        Speed = update.Speed,
                        Type = update.VesselType,
                        NavigationalStatus = update.NavigationalStatus,
                        Destination = kvp.Value.Metadata?.Destination,
                        Eta = kvp.Value.Metadata?.Eta,
                        Length = kvp.Value.Metadata?.Length,
                        Draught = kvp.Value.Metadata?.Draught
                    };
                    _vesselCache[update.MMSI] = (vesselInfo, kvp.Value.Metadata);
                }
            }
            _vesselCount = VesselPositionSignalRService.TotalVesselCount;

            // Subscribe to service events
            VesselPositionSignalRService.OnPositionUpdateReceived += HandleVesselPositionUpdate;
            VesselPositionSignalRService.OnMetadataUpdateReceived += HandleVesselMetadataUpdate;
            VesselPositionSignalRService.OnTotalVesselCountChanged += HandleVesselCountChanged;

            await VesselPositionSignalRService.StartConnection();

            ServiceRequestSignalRService.OnRequestUpdated += HandleRequestUpdated;
            await ServiceRequestSignalRService.StartConnection();

            HubConnection.On("ReceiveCompanyUpdate", async () =>
            {
                await LoadCompanyStats();
                await InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in Dashboard OnInitializedAsync: {Message}", ex.Message);
        }
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Map population is now handled by VesselMap itself
        await Task.CompletedTask;
    }

    private async void HandleVesselPositionUpdate(VesselPositionUpdateDto update)
    {
        var vesselInfo = new VesselDetailPanel.VesselPositionDto
            {
                MMSI = update.MMSI,
                VesselId = update.VesselId?.ToString() ?? update.MMSI,
                Name = update.Name,
                Latitude = update.Latitude,
                Longitude = update.Longitude,
                Heading = update.Heading,
                Speed = update.Speed,
                Type = update.VesselType,
                NavigationalStatus = update.NavigationalStatus,
                // Metadata might be null in position update, so we rely on cache or subsequent metadata update
                // CRITICAL: Preserve existing values if update doesn't have them!
                Destination = update.Metadata?.Destination ?? (_vesselCache.TryGetValue(update.MMSI, out var existing) ? existing.Info.Destination : null),
                Eta = update.Metadata?.Eta ?? (_vesselCache.TryGetValue(update.MMSI, out existing) ? existing.Info.Eta : null),
                Length = update.Metadata?.Length ?? (_vesselCache.TryGetValue(update.MMSI, out existing) ? existing.Info.Length : null),
                Draught = update.Metadata?.Draught ?? (_vesselCache.TryGetValue(update.MMSI, out existing) ? existing.Info.Draught : null),
                Width = update.Metadata?.Width ?? (_vesselCache.TryGetValue(update.MMSI, out existing) ? existing.Info.Width : null)
            };

        // Preserve existing metadata if available
        var existingMetadata = _vesselCache.TryGetValue(update.MMSI, out var cached) ? cached.Metadata : null;
        _vesselCache[update.MMSI] = (vesselInfo, update.Metadata ?? existingMetadata);

        await InvokeAsync(StateHasChanged);
    }

    private async void HandleVesselMetadataUpdate(string mmsi, VesselMetadataDto metadata)
    {
        if (_vesselCache.TryGetValue(mmsi, out var data))
        {
            var existingMetadata = data.Metadata;
            var mergedMetadata = new VesselMetadataDto
                {
                    Flag = !string.IsNullOrEmpty(metadata.Flag) ? metadata.Flag : existingMetadata?.Flag ?? string.Empty,
                    Length = metadata.Length > 0 ? metadata.Length : existingMetadata?.Length,
                    ImoNumber = !string.IsNullOrEmpty(metadata.ImoNumber) ? metadata.ImoNumber : existingMetadata?.ImoNumber ??
string.Empty,
                    ShipName = !string.IsNullOrEmpty(metadata.ShipName) ? metadata.ShipName : existingMetadata?.ShipName ?? string.Empty,
                    Callsign = !string.IsNullOrEmpty(metadata.Callsign) ? metadata.Callsign : existingMetadata?.Callsign ?? string.Empty,
                    Geartype = !string.IsNullOrEmpty(metadata.Geartype) ? metadata.Geartype : existingMetadata?.Geartype ?? string.Empty,
                    Destination = !string.IsNullOrEmpty(metadata.Destination) ? metadata.Destination : existingMetadata?.Destination ?? string.Empty,
                    Eta = metadata.Eta.HasValue ? metadata.Eta : existingMetadata?.Eta,
                    Draught = metadata.Draught.HasValue ? metadata.Draught : existingMetadata?.Draught,
                    Width = metadata.Width.HasValue ? metadata.Width : existingMetadata?.Width,
                    VesselType = !string.IsNullOrEmpty(metadata.VesselType) ? metadata.VesselType : existingMetadata?.VesselType ?? string.Empty
                };

            // Update the VesselPositionDto with the new metadata fields
            var updatedInfo = new VesselDetailPanel.VesselPositionDto
            {
                MMSI = data.Info.MMSI,
                VesselId = data.Info.VesselId,
                Name = data.Info.Name,
                Latitude = data.Info.Latitude,
                Longitude = data.Info.Longitude,
                Heading = data.Info.Heading,
                Speed = data.Info.Speed,
                Type = !string.IsNullOrEmpty(mergedMetadata.VesselType) ? mergedMetadata.VesselType : data.Info.Type,
                NavigationalStatus = data.Info.NavigationalStatus,
                Destination = mergedMetadata.Destination,
                Eta = mergedMetadata.Eta,
                Length = mergedMetadata.Length,
                Draught = mergedMetadata.Draught,
                Width = mergedMetadata.Width
            };
            // Note: VesselMetadataDto doesn't have Width in Shared DTO? I added it to VesselPositionDto but maybe not MetadataDto?
            // I checked VesselMetadataDto in step 7845. I added Destination, ETA, Draught. I did NOT add Width to VesselMetadataDto.
            // So Width must come from somewhere else or I need to add it to MetadataDto if I want it.
            // For now, I'll just copy it from previous info.

            _vesselCache[mmsi] = (updatedInfo, mergedMetadata);

            // If this is the currently selected vessel, update the selection to refresh UI
            if (_selectedVessel?.MMSI == mmsi)
            {
                _selectedVessel = updatedInfo;
                _selectedMetadata = mergedMetadata;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void HandleVesselCountChanged(int count)
    {
        _vesselCount = count;
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadServiceRequestStats()
    {
        try
        {
            var client = ClientFactory.CreateClient("HarborFlowSuite.ServerAPI");
            var serviceRequestTask = client.GetFromJsonAsync<ServiceRequest[]>("api/servicerequest");
            var serviceRequestStatusTask =
            client.GetFromJsonAsync<List<ServiceRequestStatusSummaryDto>>("api/dashboard/servicerequeststatus");

            await Task.WhenAll(serviceRequestTask, serviceRequestStatusTask);

            _pendingServiceRequestCount = serviceRequestTask.Result?.Count(r => r.Status == ServiceRequestStatus.Pending) ?? 0;
            _serviceRequestStatusSummary = serviceRequestStatusTask.Result;

            if (_serviceRequestStatusSummary != null)
            {
                var sortedSummary = _serviceRequestStatusSummary.OrderBy(x =>
                {
                    return x.Status switch
                    {
                        "Pending" => 0,
                        "Approved" => 1,
                        "Rejected" => 2,
                        "InProgress" => 3,
                        "Completed" => 4,
                        "Cancelled" => 5,
                        _ => 6
                    };
                }).ToList();

                _serviceRequestLabels = sortedSummary.Select(x => x.Status).ToArray();
                _serviceRequestData = sortedSummary.Select(x => (double)x.Count).ToArray();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing service request stats");
        }
    }

    private async Task LoadCompanyStats()
    {
        try
        {
            var client = ClientFactory.CreateClient("HarborFlowSuite.ServerAPI");
            var companyTask = client.GetFromJsonAsync<Company[]>("api/company");
            await companyTask;
            _companyCount = companyTask.Result?.Length ?? 0;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing company stats");
        }
    }

    private void OnVesselSelected(string mmsi)
    {
        if (_vesselCache.TryGetValue(mmsi, out var data))
        {
            _selectedVessel = data.Info;
            _selectedMetadata = data.Metadata;
            _isDetailPanelOpen = true;
            StateHasChanged();
        }
    }

    private void OnVesselCountChanged(int count)
    {
        // This is now handled by HandleVesselCountChanged via SignalR service
        // But the VesselMap component also emits this event.
        // We can keep this for map-specific counts if needed, but _vesselCount is global.
        // Let's rely on the service for total count.
        // Actually, VesselMap might filter vessels, so this count might be "visible vessels".
        // The previous implementation updated _vesselCount from the map.
        // Let's keep it consistent with previous behavior for now, or decide if _vesselCount means "Total in system" or "Visible on map".
        // The UI says "Total Vessels".
        // The service provides "TotalVesselCount" (all active).
        // The map provides "OnTotalMapVesselCountChanged".
        // Let's stick to the service count for "Total Vessels" card, as it persists.
        // But wait, the map might have more logic.
        // Let's use the service count.
    }

    private void OnVesselTypeSummaryChanged(List<VesselTypeSummaryDto> summary)
    {
        _vesselTypeSummary = summary;
        // Update chart data dynamically if needed
        if (_vesselTypeSummary != null)
        {
            _vesselTypeLabels = _vesselTypeSummary.Select(x => x.VesselType).ToArray();
            _vesselTypeData = _vesselTypeSummary.Select(x => (double)x.Count).ToArray();
        }
        StateHasChanged();
    }

    private async Task OnLayerSelected(string layerKey)
    {
        _selectedLayer = layerKey;
        await JSRuntime.InvokeVoidAsync("HarborFlowMap.switchLayer", layerKey);
    }

    private bool _isMapFullScreen = false;

    private void ToggleMapFullScreen()
    {
        _isMapFullScreen = !_isMapFullScreen;
    }

    private async void HandleRequestUpdated()
    {
        await LoadServiceRequestStats();
        await InvokeAsync(StateHasChanged);
    }

    private Port _selectedPort;
    private int? _selectedPortCongestion;
    private bool _isPortDetailPanelOpen;

    private void OnPortCitySelected(string city)
    {
        var port = _ports.FirstOrDefault(p => p.City == city);
        if (port == null) return;

        _selectedPort = port;
        _isPortDetailPanelOpen = true; 
        
        // Calculate real-time congestion based on cached vessel positions
        // We count vessels within 20km radius
        _selectedPortCongestion = GetVesselCountNearPort(port, 20.0);
        
        StateHasChanged(); 
    }

    private int GetVesselCountNearPort(Port port, double radiusKm)
    {
        if (port == null || _vesselCache == null) return 0;

        int count = 0;
        foreach (var vesselData in _vesselCache.Values)
        {
            var vessel = vesselData.Info;
            if (vessel != null)
            {
                double distance = CalculateDistance(port.Latitude, port.Longitude, vessel.Latitude, vessel.Longitude);
                if (distance <= radiusKm)
                {
                    count++;
                }
            }
        }
        return count;
    }

    private double CalculateDistance(double lat1, double lon1, double lat2, double lon2)
    {
        // Haversine formula
        double R = 6371; // Earth radius in km
        double dLat = ToRadians(lat2 - lat1);
        double dLon = ToRadians(lon2 - lon1);
        
        double a = Math.Sin(dLat / 2) * Math.Sin(dLat / 2) +
                   Math.Cos(ToRadians(lat1)) * Math.Cos(ToRadians(lat2)) *
                   Math.Sin(dLon / 2) * Math.Sin(dLon / 2);
                   
        double c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1 - a));
        return R * c;
    }

    private double ToRadians(double angle)
    {
        return Math.PI * angle / 180.0;
    }

    public async ValueTask DisposeAsync()
    {
        ServiceRequestSignalRService.OnRequestUpdated -= HandleRequestUpdated;
        VesselPositionSignalRService.OnPositionUpdateReceived -= HandleVesselPositionUpdate;
        VesselPositionSignalRService.OnMetadataUpdateReceived -= HandleVesselMetadataUpdate;
        VesselPositionSignalRService.OnTotalVesselCountChanged -= HandleVesselCountChanged;
        await Task.CompletedTask;
    }
}

<style>
    .glass-card {
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Dark Mode Styles */
    ::deep .theme-dark .glass-card,
    .theme-dark .glass-card {
        background: rgba(30, 41, 59, 0.7) !important;
        /* Slate 800 with opacity */
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    ::deep .theme-dark .glass-card:hover,
    .theme-dark .glass-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        border-color: rgba(59, 130, 246, 0.4);
        /* Primary color border on hover */
        background: rgba(30, 41, 59, 0.85) !important;
    }

    /* Light Mode Styles */
    ::deep .theme-light .glass-card,
    .theme-light .glass-card {
        background: rgba(255, 255, 255, 0.7) !important;
        /* White with opacity */
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    ::deep .theme-light .glass-card:hover,
    .theme-light .glass-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.05);
        border-color: rgba(59, 130, 246, 0.5);
        /* Primary color border on hover */
        background: rgba(255, 255, 255, 0.9) !important;
    }

    .shadow-lg {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .hover-underline:hover {
        text-decoration: underline;
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        opacity: 0;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .relative {
        position: relative;
    }

    .absolute-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 0;
    }

    .pointer-events-none {
        pointer-events: none;
    }
</style>
