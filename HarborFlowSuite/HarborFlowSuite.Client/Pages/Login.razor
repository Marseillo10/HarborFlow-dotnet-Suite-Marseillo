@page "/login"
@using HarborFlowSuite.Client.Services
@using HarborFlowSuite.Client.Models
@using Microsoft.AspNetCore.Components.Authorization
@using HarborFlowSuite.Client.Layout
@layout AuthLayout
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<Login> Logger

<MudCard Elevation="4" Class="glass-card rounded-xl pa-4 animate-fade-in-up" Style="width: 100%; max-width: 400px;">
    <MudCardHeader Class="d-flex justify-center">
        <CardHeaderContent>
            <div class="d-flex flex-column align-center">
                <MudIcon Icon="@Icons.Material.Filled.Anchor" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
                <MudText Typo="Typo.h4" Class="font-weight-bold">Welcome Back</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">Sign in to HarborFlow</MudText>
            </div>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <EditForm Model="@_loginModel" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />

            <MudTextField @bind-Value="_loginModel.Email" Label="Email" Variant="Variant.Outlined"
                Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Email" Class="mb-4"
                FullWidth="true" />

            <MudTextField @bind-Value="_loginModel.Password" Label="Password" Variant="Variant.Outlined"
                InputType="@_passwordInputType" Adornment="Adornment.End" AdornmentIcon="@_passwordInputIcon"
                OnAdornmentClick="TogglePasswordVisibility" Class="mb-1" FullWidth="true" />

            <div class="d-flex justify-end mb-4">
                <MudLink Href="/forgot-password" Typo="Typo.caption" Color="Color.Primary" Underline="Underline.Hover">
                    Forgot Password?</MudLink>
            </div>

            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                Size="Size.Large" Class="mt-2 shadow-lg">
                Login
            </MudButton>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4" Dense="true">@_errorMessage</MudAlert>
            }
        </EditForm>
    </MudCardContent>
    <MudCardActions Class="d-flex justify-center pb-4">
        <MudText Typo="Typo.body2">Don't have an account? <MudLink Href="/register" Color="Color.Primary"
                Underline="Underline.Hover">Register here</MudLink>
        </MudText>
    </MudCardActions>
</MudCard>

<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.1) !important;
        /* Default for light mode compatibility */
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    /* Dark mode specific override handled by MudBlazor theme or parent class if needed, 
       but glassmorphism usually works well with semi-transparent white/black */

    .mud-theme-dark .glass-card {
        background: rgba(30, 41, 59, 0.7) !important;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        opacity: 0;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@code {
    private readonly LoginModel _loginModel = new() { Email = "", Password = "" };
    private string? _errorMessage;
    private bool _isShow;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordInputIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        if (_isShow)
        {
            _isShow = false;
            _passwordInputIcon = Icons.Material.Filled.VisibilityOff;
            _passwordInputType = InputType.Password;
        }
        else
        {
            _isShow = true;
            _passwordInputIcon = Icons.Material.Filled.Visibility;
            _passwordInputType = InputType.Text;
        }
    }

    private async Task HandleLogin()
    {
        Logger.LogInformation("HandleLogin called");
        try
        {
            bool success = await AuthService.SignIn(_loginModel.Email, _loginModel.Password);
            Logger.LogInformation("SignIn success: {Success}", success);
            if (success)
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                Logger.LogInformation("IsAuthenticated: {IsAuthenticated}", authState.User.Identity?.IsAuthenticated);
                if (authState.User.Identity?.IsAuthenticated == true)
                {
                    NavigationManager.NavigateTo("/dashboard");
                }
                else
                {
                    _errorMessage = "Login successful, but authentication state not updated. Please try again.";
                }
            }
            else
            {
                _errorMessage = "Login failed. Please check your credentials.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            Logger.LogError(ex, "Login exception: {Message}", ex.Message);
        }
    }
}
