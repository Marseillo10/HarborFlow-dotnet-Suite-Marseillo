@page "/news"
@using HarborFlowSuite.Core.DTOs
@using HarborFlowSuite.Client.Services
@inject INewsService NewsService
@inject NavigationManager NavigationManager

<PageTitle>Maritime News</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <MudText Typo="Typo.h4">Maritime News</MudText>
        <MudTextField @bind-Value="_searchTerm" Placeholder="Search news..." Adornment="Adornment.Start"
            AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true"
            TextChanged="FilterNews"></MudTextField>
    </div>

    @if (_isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_filteredNews == null || !_filteredNews.Any())
    {
        <MudAlert Severity="Severity.Info">No news found.</MudAlert>
    }
    else
    {
        <MudGrid>
            @foreach (var item in _filteredNews)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4" Class="h-100 d-flex flex-column">
                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            <MudCardMedia Image="@item.ImageUrl" Height="200" />
                        }
                        <MudCardContent Class="flex-grow-1">
                            <MudText Typo="Typo.h6">@item.Title</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@item.Source -
                                @item.PublishDate.ToLocalTime().ToString("g")</MudText>
                            <MudText Typo="Typo.body2" Class="mt-2">@((MarkupString)Truncate(item.Summary, 150))</MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@item.Link" Target="_blank">Read More
                                </MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
            }
        </MudGrid>
    }
    </MudContainer>

    @code {
    private List<NewsItemDto> _allNews = new();
    private List<NewsItemDto> _filteredNews = new();
    private string _searchTerm = string.Empty;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _allNews = await NewsService.GetNews();
            _filteredNews = _allNews;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterNews(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            _filteredNews = _allNews;
        }
        else
        {
            _filteredNews = _allNews.Where(n =>
            n.Title.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            n.Summary.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            n.Source.Contains(value, StringComparison.OrdinalIgnoreCase)
            ).ToList();
        }
    }

    private string Truncate(string value, int maxLength)
    {
        if (string.IsNullOrEmpty(value)) return value;
        return value.Length <= maxLength ? value : value.Substring(0, maxLength) + "...";
    }
}
