@using HarborFlowSuite.Core.Models
@using HarborFlowSuite.Client.Services
@using MudBlazor
@inject IServiceRequestService ServiceRequestService

<MudDialog>
    <DialogContent>
        @if (_loading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (_serviceRequest != null && _serviceRequest.ApprovalHistories != null &&
        _serviceRequest.ApprovalHistories.Any())
        {
            <MudTimeline TimelinePosition="TimelinePosition.Start">
                @foreach (var history in _serviceRequest.ApprovalHistories.OrderByDescending(h => h.CreatedAt))
                {
                    <MudTimelineItem Color="@GetColorForAction(history.Action)" Size="Size.Small">
                        <ItemOpposite>
                            <MudText Typo="Typo.caption" Color="Color.Default">@history.CreatedAt.ToLocalTime().ToString("g")
                            </MudText>
                        </ItemOpposite>
                        <ItemContent>
                            <MudPaper Elevation="0" Class="pa-2">
                                <MudText Typo="Typo.subtitle2">@history.Action</MudText>
                                <MudText Typo="Typo.body2">by @(history.Approver?.FullName ?? "Unknown")</MudText>
                                    @if (!string.IsNullOrEmpty(history.Comments))
                                {
                                    <MudText Typo="Typo.caption" Class="mt-1">"@history.Comments"</MudText>
                                }
                            </MudPaper>
                        </ItemContent>
                    </MudTimelineItem>
                }
            </MudTimeline>
        }
        else
        {
            <MudText Typo="Typo.body1" Align="Align.Center">No history available for this request.</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    [Parameter] public Guid ServiceRequestId { get; set; }

    private ServiceRequest _serviceRequest;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _serviceRequest = await ServiceRequestService.GetServiceRequestById(ServiceRequestId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading history: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private Color GetColorForAction(string action)
    {
        if (string.IsNullOrEmpty(action)) return Color.Default;
        if (action.Contains("Created", StringComparison.OrdinalIgnoreCase)) return Color.Info;
        if (action.Contains("Edited", StringComparison.OrdinalIgnoreCase)) return Color.Default;
        if (action.Contains("Approved", StringComparison.OrdinalIgnoreCase)) return Color.Success;
        if (action.Contains("Rejected", StringComparison.OrdinalIgnoreCase)) return Color.Error;
        return Color.Default;
    }
}
