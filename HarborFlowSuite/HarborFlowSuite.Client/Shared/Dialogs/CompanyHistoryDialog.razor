@using HarborFlowSuite.Core.Models
@using HarborFlowSuite.Client.Services
@using MudBlazor
@inject ICompanyService CompanyService

<MudDialog>
    <DialogContent>
        @if (_loading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (_company != null && _company.Histories != null && _company.Histories.Any())
        {
            <MudTimeline TimelinePosition="TimelinePosition.Start">
                @foreach (var history in _company.Histories.OrderByDescending(h => h.CreatedAt))
                {
                    <MudTimelineItem Color="@GetColorForAction(history.Action)" Size="Size.Small">
                        <ItemOpposite>
                            <MudText Typo="Typo.caption" Color="Color.Default">@history.CreatedAt.ToLocalTime().ToString("g")
                            </MudText>
                        </ItemOpposite>
                        <ItemContent>
                            <MudPaper Elevation="0" Class="pa-2">
                                <MudText Typo="Typo.subtitle2">@history.Action</MudText>
                                @if (!string.IsNullOrEmpty(history.ChangeDetails))
                                {
                                    <MudText Typo="Typo.caption" Class="mt-1">@history.ChangeDetails</MudText>
                                }
                            </MudPaper>
                        </ItemContent>
                    </MudTimelineItem>
                }
            </MudTimeline>
        }
        else
        {
            <MudText Typo="Typo.body1" Align="Align.Center">No history available for this company.</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    [Parameter] public Guid CompanyId { get; set; }

    private Company _company;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _company = await CompanyService.GetCompany(CompanyId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading history: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private Color GetColorForAction(string action)
    {
        if (string.IsNullOrEmpty(action)) return Color.Default;
        if (action.Contains("Created", StringComparison.OrdinalIgnoreCase)) return Color.Info;
        if (action.Contains("Updated", StringComparison.OrdinalIgnoreCase)) return Color.Warning;
        return Color.Default;
    }
}
