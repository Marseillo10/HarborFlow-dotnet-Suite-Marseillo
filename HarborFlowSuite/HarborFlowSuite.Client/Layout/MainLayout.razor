@using Microsoft.AspNetCore.SignalR.Client
@using HarborFlowSuite.Client.Services
@using HarborFlowSuite.Core.Services
@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase
@inject HubConnection HubConnection

<MudThemeProvider Theme="_theme" IsDarkMode="_isDarkMode" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        @if (!string.IsNullOrEmpty(_companyLogoUrl))
        {
            <MudImage Src="@_companyLogoUrl" Height="40" Class="ml-3" Alt="@_companyName" />
        }
        else
        {
            <MudText Typo="Typo.h5" Class="ml-3">HarborFlow</MudText>
        }
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Brightness4" Color="@(_isDarkMode ? Color.Inherit : Color.Primary)"
            OnClick="@((e) => _isDarkMode = !_isDarkMode)" />
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2" Variant="@DrawerVariant.Mini" OpenMiniOnHover="true">
        <NavMenu />
    </MudDrawer>
    <MudMainContent Style="@GetMainContentStyle()" Class="@(_isDarkMode ? "theme-dark" : "theme-light")">
        <MudContainer MaxWidth="MaxWidth.Large" Class="my-4 pt-4">
            <ConnectionStatusBanner />
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

<style>
    /* Hide content when drawer is in mini mode (collapsed) */
    .mud-drawer-mini .mini-hide {
        display: none !important;
    }
    
    /* Ensure icons are centered in mini mode */
    .mud-drawer-mini .mud-nav-link {
        justify-content: center;
    }
    
    .mud-drawer-mini .mud-nav-link-icon {
        margin-right: 0 !important;
    }

    /* Explicitly hide NavLink text in mini mode */
    .mud-drawer-mini .mud-nav-link-text {
        display: none !important;
    }

    /* Show NavLink text when drawer is hovered (expanded) */
    .mud-drawer-mini:hover .mud-nav-link-text {
        display: block !important;
    }

    /* Show hidden content (MENU, Profile, Logout) on hover */
    .mud-drawer-mini:hover .mini-hide {
        display: block !important;
    }

    /* Restore flex layout for profile container on hover */
    .mud-drawer-mini:hover .d-flex.mini-hide {
        display: flex !important;
    }

    /* Restore inline-flex for buttons on hover */
    .mud-drawer-mini:hover .mud-button.mini-hide {
        display: inline-flex !important;
    }

    /* Hide the icon-only logout button on hover (since full button is shown) */
    .mud-drawer-mini:hover .d-flex-mini {
        display: none !important;
    }
</style>

@code {
    bool _drawerOpen = false;
    bool _isDarkMode = true;
    MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#0EA5E9", // Sky 500 - Vibrant, modern blue
            Secondary = "#10B981", // Emerald 500
            AppbarBackground = "rgba(255, 255, 255, 0.8)", // Glassy white
            Background = "#F0F9FF", // Sky 50 - Very subtle light blue tint
            DrawerBackground = "#FFFFFF",
            Surface = "#FFFFFF", // Solid white for better readability
            TextPrimary = "#0F172A", // Slate 900 - Deep dark blue/gray
            TextSecondary = "#475569", // Slate 600
            ActionDefault = "#64748B",
            ActionDisabled = "#94A3B8",
            Divider = "#E2E8F0",
            TableLines = "#E2E8F0",
            Tertiary = "#7C3AED", // Violet 600
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#3B82F6", // Bright Blue
            Secondary = "#14B8A6", // Teal
            Tertiary = "#594AE2", // Purple - Distinct from Primary Blue
            Background = "#0F172A", // Slate 900
            AppbarBackground = "#0F172A",
            DrawerBackground = "#0F172A",
            Surface = "#1E293B", // Slate 800
            TextPrimary = "#F3F4F6",
            TextSecondary = "#9CA3AF",
            ActionDefault = "#E5E7EB",
            ActionDisabled = "#4B5563",
            Divider = "#334155",
            TableLines = "#334155",
        }
    };

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    [Inject] IJSRuntime JSRuntime { get; set; }
    [Inject] IDialogService DialogService { get; set; }
    [Inject] IIdleTimeoutService IdleTimeoutService { get; set; }
    [Inject] NavigationManager NavigationManager { get; set; }
    [Inject] IAuthService AuthService { get; set; }
    [Inject] AuthenticationStateProvider AuthenticationStateProvider { get; set; }
    [Inject] IHttpClientFactory ClientFactory { get; set; }

    private string? _companyLogoUrl;
    private string? _companyName;

    protected override async Task OnInitializedAsync()
    {
        if (HubConnection.State == HubConnectionState.Disconnected)
        {
            try
            {
                await HubConnection.StartAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error starting SignalR connection: {ex.Message}");
            }
        }
        
        IdleTimeoutService.OnTimeout += HandleIdleTimeout;

        await LoadCompanyBranding();
    }

    private async Task LoadCompanyBranding()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                var firebaseUid = user.FindFirst(c => c.Type == "user_id")?.Value 
                                  ?? user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

                if (!string.IsNullOrEmpty(firebaseUid))
                {
                    var client = ClientFactory.CreateClient("HarborFlowSuite.ServerAPI");
                    // We need to find the user to get CompanyId. 
                    // Ideally we should have an endpoint "api/users/me" or similar.
                    // For now, I'll fetch all users and filter (inefficient but consistent with current app).
                    // OR better: Fetch the user profile specifically if I can.
                    // I'll try to fetch the user by Firebase UID if I can, or just use the list.
                    // Actually, `UserProfile.razor` fetches `api/users` and filters. I'll do the same for now.
                    
                    var users = await client.GetFromJsonAsync<List<HarborFlowSuite.Shared.DTOs.UserDto>>("api/users");
                    var currentUserDto = users?.FirstOrDefault(u => u.FirebaseUid == firebaseUid);

                    if (currentUserDto?.CompanyId != null)
                    {
                        var company = await client.GetFromJsonAsync<HarborFlowSuite.Core.Models.Company>($"api/company/{currentUserDto.CompanyId}");
                        if (company != null)
                        {
                            _companyLogoUrl = company.LogoUrl;
                            _companyName = company.Name;
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading company branding: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("registerCommandPaletteShortcut", dotNetHelper);
            
            // Initialize idle timer (15 minutes = 15)
            await IdleTimeoutService.InitializeAsync(15);
        }
    }
    
    private void HandleIdleTimeout()
    {
        // We need to invoke this on the UI thread since it's triggered from a timer/JS
        InvokeAsync(async () =>
        {
            await AuthService.SignOut();
            NavigationManager.NavigateTo("/login");
        });
    }

    public void Dispose()
    {
        IdleTimeoutService.OnTimeout -= HandleIdleTimeout;
        _ = IdleTimeoutService.DisposeAsync();
    }

    [JSInvokable]
    public async Task OpenCommandPalette()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            NoHeader = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };
        await DialogService.ShowAsync<Components.CommandPalette>("", options);
    }

    private string GetMainContentStyle()
    {
        if (_isDarkMode)
        {
            return "background: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.95)), url('/images/background-map.png'); background-size: cover; background-position: center; background-attachment: fixed; min-height: 100vh;";
        }
        else
        {
            // Premium Light Mode Background: Subtle gradient with abstract overlay
            return "background: linear-gradient(rgba(255, 255, 255, 0.85), rgba(240, 249, 255, 0.9)), url('/images/light_mode_bg.png'); background-size: cover; background-position: center; background-attachment: fixed; min-height: 100vh;";
        }
    }
}
