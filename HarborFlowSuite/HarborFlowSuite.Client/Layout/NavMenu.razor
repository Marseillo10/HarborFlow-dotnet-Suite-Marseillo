@using Microsoft.AspNetCore.Components.Authorization
@using HarborFlowSuite.Client.Services
@using HarborFlowSuite.Shared.Constants
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<div class="d-flex flex-column h-100">
    <MudNavMenu>
        <MudText Typo="Typo.subtitle2" Class="px-4 mt-4 mb-2 mud-text-secondary mini-hide"><b>MENU</b></MudText>
        <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
        <AuthorizeView>
            <Authorized>
                <MudNavLink Href="dashboard" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
                <MudNavLink Href="nautical-chart" Icon="@Icons.Material.Filled.Map">Nautical Chart</MudNavLink>
                <AuthorizeView Policy="@Permissions.Vessels.View" Context="viewVesselsContext">
                    <Authorized>
                        <MudNavLink Href="vessel-management" Icon="@Icons.Material.Filled.DirectionsBoat">Vessel
                            Management
                        </MudNavLink>
                    </Authorized>
                </AuthorizeView>
                <AuthorizeView Policy="@Permissions.ServiceRequests.View" Context="viewServiceRequestsContext">
                    <Authorized>
                        <MudNavLink Href="service-request-management" Icon="@Icons.Material.Filled.Build">Service
                            Requests
                        </MudNavLink>
                    </Authorized>
                </AuthorizeView>
                <MudNavLink Href="news" Icon="@Icons.Material.Filled.Newspaper">Maritime News</MudNavLink>
                <AuthorizeView Policy="@Permissions.Users.View" Context="viewUsersContext">
                    <Authorized>
                        <MudNavLink Href="user-management" Match="NavLinkMatch.Prefix"
                            Icon="@Icons.Material.Filled.People">User Management</MudNavLink>
                    </Authorized>
                </AuthorizeView>
                <AuthorizeView Policy="@Permissions.Companies.Manage" Context="manageCompanyContext">
                    <Authorized>
                        <MudNavLink Href="company-management" Icon="@Icons.Material.Filled.Business">Company Management
                        </MudNavLink>
                    </Authorized>
                </AuthorizeView>
            </Authorized>
        </AuthorizeView>
    </MudNavMenu>

    <MudSpacer />

    <AuthorizeView>
        <Authorized>
            <div class="pa-4">
                <MudDivider Class="mb-4" />
                <div class="d-flex align-center gap-3 mb-4 cursor-pointer user-profile-link"
                @onclick='() => NavigationManager.NavigateTo("/user-profile")'>
                    <MudAvatar Color="Color.Secondary" Variant="Variant.Filled">
                        @(context.User.Identity?.Name?.FirstOrDefault().ToString().ToUpper() ?? "U")
                    </MudAvatar>
                    <div class="d-flex flex-column mini-hide">
                        <MudText Typo="Typo.subtitle2"><b>@(context.User.Identity?.Name ?? "User")</b></MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                            @(context.User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "User")
                        </MudText>
                    </div>
                </div>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true"
                    StartIcon="@Icons.Material.Filled.Logout" OnClick="HandleLogout" Class="mini-hide">
                    Log Out
                </MudButton>
                <!-- Icon-only logout button for mini mode -->
                <div class="d-none d-flex-mini justify-center">
                    <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Error" OnClick="HandleLogout" />
                </div>
            </div>
        </Authorized>
        <NotAuthorized>
            <MudNavMenu>
                <MudDivider Class="my-2" />
                <MudNavLink Href="register" Icon="@Icons.Material.Filled.PersonAdd">Register</MudNavLink>
                <MudNavLink Href="login" Icon="@Icons.Material.Filled.Login">Login</MudNavLink>
            </MudNavMenu>
        </NotAuthorized>
    </AuthorizeView>
</div>

<style>
    .cursor-pointer {
        cursor: pointer;
    }

    .user-profile-link:hover {
        opacity: 0.8;
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        padding: 4px;
        margin: -4px;
        /* Compensate for padding */
        transition: all 0.2s;
    }

    /* Show icon-only logout in mini mode */
    .mud-drawer-mini .d-flex-mini {
        display: flex !important;
    }

    .mud-drawer-mini .d-none.d-flex-mini {
        display: flex !important;
    }
</style>

@code {
    private async Task HandleLogout()
    {
        await AuthService.SignOut();
        NavigationManager.NavigateTo("/");
    }
}
